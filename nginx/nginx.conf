# Nginx 메인 설정: 운영(/) → app:4000, 개발(/dev) → app_dev:4001
user  nginx;
worker_processes  auto;

events {
  worker_connections  1024;
}

http {
  include       mime.types;
  default_type  application/octet-stream;
  sendfile      on;
  keepalive_timeout  65;

  # 업스트림: 컨테이너 서비스명으로 지정 (Compose DNS)
  upstream app_prod { server app:4000; }
  upstream app_dev  { server app_dev:4001; }

  server {
    listen 80;
    server_name _;

    # 공통 프록시 설정
    include /etc/nginx/proxy_params;

    # ── 운영 트래픽: 루트(/) 전부 운영 앱으로
    location / {
      proxy_pass http://app_prod;
    }

    # ── 개발 트래픽: /dev/* → 개발 앱
    #     /dev 접두어를 제거하고 앱에 전달 (ex: /dev/docs → /docs)
    location /dev/ {
      rewrite ^/dev/(.*)$ /$1 break;
      proxy_pass http://app_dev;
    }

    # 헬스체크(선택)
    location = /nginx-health {
      access_log off;
      return 200 "ok\n";
    }
  }
}
